---
title: "Synthetic Controls"
date: 'Report generated `r format(Sys.time(), "%A, %B %d, %Y")`'
knit: (function(inputFile, encoding) { 
      country <<- 'SC_Dec/HDIxSuperRegion';
      out_dir <- paste(paste('~/Documents/Synthetic Control Data/', country, '/', sep = ''), 'results', sep = '');
      rmarkdown::render(inputFile,
                        encoding = encoding, 
                        output_file = file.path(out_dir, 'analysis.html')) })
output:
 html_document:
  toc: TRUE
  toc_float: TRUE
---

```{r setup, include = FALSE}
library('parallel', quietly = TRUE)
library('splines', quietly = TRUE)
library('lubridate', quietly = TRUE)
library('CausalImpact', quietly = TRUE)
library('zoo', quietly = TRUE)
knitr::opts_chunk$set(echo = FALSE)
```

```{r analysis, include = FALSE}
source('~/GitHub/synthetic-control/synthetic_control_analysis_function.R')
original_country <- country
results <- syntheticControl(country = country, use_defaults = TRUE)
country <- gsub('/', '_', country)
```

#`r country` Results

```{r sparse}
knitr::kable(data.frame('Sparse Groups' = names(results$sparse_groups[results$sparse_groups]), check.names = FALSE))
```

##ITS
```{r ITS}
knitr::kable(results$rr_mean_time)
```

##Synthetic Controls
```{r SC}
knitr::kable(results$rr_mean_full)
```

##Weight Sensitivity Analysis
```{r sensitivity}
knitr::kable(results$sensitivity_table, align = 'c')
```

##Pred Sensitivity Analysis
```{r pred_sensitivity}
knitr::kable(results$pred_sensitivity$pred_2, align = 'c', caption = 'n_pred = 2')
knitr::kable(results$pred_sensitivity$pred_10, align = 'c', caption = 'n_pred = 10')
```

##Plots
```{r plots, results = 'asis'}
plot_data_full <- read.csv(paste(results$output_directory, 'impact_responses/', country, '_impact_full', '_response.csv', sep = ''), check.names = FALSE, stringsAsFactors = FALSE)
plot_data_time <- read.csv(paste(results$output_directory, 'impact_responses/', country, '_impact_time', '_response.csv', sep = ''), check.names = FALSE, stringsAsFactors = FALSE)
for (group in results$groups) {
	cat('###', group, '\n', sep = '')
	plotPred(results$pred_quantiles_full[, , group], results$time_points, results$post_period, results$pred_quantiles_full[, , group], results$outcome_plot[, group], country, title = paste(group, 'Synthetic controls estimate'))
		plotPred(results$pred_quantiles_time[, , group], results$time_points, results$post_period, results$pred_quantiles_full[, , group], results$outcome_plot[, group], country, title = paste(group, 'Interupted time series estimate'))
	cat('\n\n')
}
```